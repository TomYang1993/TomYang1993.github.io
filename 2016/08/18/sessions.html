<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sessions</title>
  <meta name="description" content="HTTP is stateless ?what does that even mean? It means that HTTP belongs to the world and it has no nationality, every man on the earth can use it. Do you bel...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/2016/08/18/sessions.html">
  <link rel="alternate" type="application/rss+xml" title="Tom Yang's Creative Factory" href="http://localhost:4000/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Tom Yang's Creative Factory</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Sessions</h1>
    <p class="post-meta"><time datetime="2016-08-18T00:00:00-04:00" itemprop="datePublished">Aug 18, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="http-is-stateless-">HTTP is stateless ?</h2>
<p>what does that even mean? It means that HTTP belongs to the world and it has no nationality, every man on the earth can use it. Do you believe that?</p>

<p>Just kidding! It means every HTTP request is a new action. The server or client who uses the server won’t remember they have connected once, they don’t remember anything and every request is a new connection. So no one will remember the state such as user’s password, user’s id, user’s email. so it is stateless!</p>

<h2 id="so-who-remembers-or-carries-the-info-">So who remembers or carries the info ?</h2>
<p>Cookies! I won’t dig into cookies, maybe next post. Cookies can tell a particular user who is logged in as the current user, and sessions will store some useful data about the user. When you want to keep track of data in the user’s session, which represents all the stuff your user does while you’ve chosen to remember the user, typically until the browser window is closed. In that case, every page he visits until the browser is closed will be part of the same session.</p>

<p>So sessions can retain info during multiple requests, and users will always have data in the session even though the HTTP is stateless.</p>

<blockquote>
  <p>HTTP is a stateless protocol. Sessions make it stateful. —— rails guide</p>
</blockquote>

<blockquote>
  <p>Most applications need to keep track of certain state of a particular user. This could be the contents of a shopping basket or the user id of the currently logged in user. Without the idea of sessions, the user would have to identify, and probably authenticate, on every request. Rails will create a new session automatically if a new user accesses the application. It will load an existing session if the user has already used the application. —— rails guide</p>
</blockquote>

<h2 id="session-in-an-app">Session in an app</h2>
<p>Sessions can store a lot of info, I will take the minicapstone as example, to explain the sessions. And this is only an example, other usages of session will be for you to explore.</p>

<p>Now we have an app, and it has a user model.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>
  <span class="n">has_many</span> <span class="ss">:carted_products</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :carted_products</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span><span class="ss">minimum: </span><span class="mi">8</span><span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">create_table</span> <span class="s2">"users"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"email"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"password_digest"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span><span class="p">,</span>                      <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span>                      <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span>  <span class="s2">"admin"</span><span class="p">,</span>           <span class="ss">default: </span><span class="kp">false</span></code></pre></figure>

<p><strong>So I can create a user(normally it is the user who put in the data) which contains his id and other info in the database, and database is acting as my server now. Follow the route below.</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">get</span> <span class="s1">'/signup'</span> <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">post</span> <span class="s1">'/users'</span> <span class="o">=&gt;</span> <span class="s1">'users#create'</span>
  </code></pre></figure>

<p><strong>Now I have two users!</strong></p>

<p><img src="/assets/Screen Shot 2016-08-19 at 10.27.09 PM.png" alt="" /></p>

<p><strong>Now we have to make sure when a user log in, his info will be saved and used until the user log out. First, we set the route and create a session controller.</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">get</span> <span class="s1">'/login'</span> <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span> <span class="s1">'/login'</span> <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'/logout'</span> <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  </code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">new</span>
    <span class="n">render</span> <span class="s2">"new.html.erb"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:password</span><span class="p">])</span>
      <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Successfully logged in!"</span>
      <span class="n">redirect_to</span> <span class="s1">'/products'</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:warning</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Invalid password or email!"</span>
      <span class="n">redirect_to</span> <span class="s1">'/login'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">session</span><span class="p">[</span><span class="ss">:cart_count</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Successfully logged out!"</span>
    <span class="n">redirect_to</span> <span class="s2">"/login"</span>
  <span class="k">end</span>
  </code></pre></figure>

<p><strong>When we go to the login page and hit “log in”, we are hitting the session controller’s create action. If the email and password are correct, it gives session a user’s id and now session can tell between the two users. Along with creating, there is a destroy action when a user decide to log out and his info will be wiped out in the system because session has been set to nil.</strong></p>

<p><strong>And what? It seems useless! It is doing nothing!</strong></p>

<p><strong>That’s not true!</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="n">helper_method</span> <span class="ss">:current_user</span>
  </code></pre></figure>

<p><strong>In the application controller, you can find your current user by the info stored in the session, for example: user_id. Now you can always track your current user! That is because even if every request wipes out instance variable, when you call <code class="highlighter-rouge">current_user</code>, it will reset the current_user variable and always keep the variable up to date!</strong></p>

<p><strong>Then you are free to use current_user in the view or in the controller and don’t have to worry about web requests take away the values of the variables!</strong>je</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Tom Yang's Creative Factory</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Tom Yang's Creative Factory</li>
          <li><a href="mailto:xy2286@columbia.edu">xy2286@columbia.edu</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/TomYang1993"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">TomYang1993</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jekyllrb"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jekyllrb</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Full-stack Web Developer! Just a freshman in the field, One day I will become someone!
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
